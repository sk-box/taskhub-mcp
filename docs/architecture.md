# TaskHub MCP アーキテクチャ

## システム概要

TaskHub MCPは、AIエージェントを主要なユーザーとして設計された、Gitネイティブなタスク管理システムです。Model Context Protocol (MCP)を使用してClaude Codeと直接統合し、開発タスクの管理と実行を効率化します。

## アーキテクチャ原則

### 1. AIファースト設計
- **API最適化**: 人間のUIではなく、AIが理解・操作しやすいAPIインターフェース
- **セマンティックレスポンス**: AIが次のアクションを判断しやすいエラーメッセージとレスポンス
- **バッチ操作**: 複数タスクの一括処理をサポート

### 2. Gitネイティブ
- **Markdownが真実の源**: すべてのタスクデータはMarkdownファイルとして保存
- **完全な履歴追跡**: Gitによるバージョン管理で全変更履歴を保持
- **ブランチ対応**: 異なるブランチで異なるタスクセットを管理可能

### 3. 疎結合アーキテクチャ
- **データベースは二次的**: TinyDBは検索インデックスとしてのみ使用
- **ファイルシステム中心**: Markdownファイルの存在が優先
- **同期メカニズム**: ファイルとDBの双方向同期

## システムコンポーネント

### コア層

```
┌─────────────────────────────────────────────────────────────┐
│                        MCP クライアント                      │
│                      (Claude Code, etc.)                    │
└────────────────────────────┬────────────────────────────────┘
                             │ MCP Protocol (SSE)
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                      MCP サーバー層                          │
│  ┌─────────────────┐     ┌──────────────────┐             │
│  │   main.py       │────▶│  FastAPI-MCP     │             │
│  │ (Entry Point)   │     │  (MCP Adapter)   │             │
│  └─────────────────┘     └──────────────────┘             │
└────────────────────────────┬────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                        API層                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    api.py                            │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐   │   │
│  │  │  /tasks    │  │ /tasks/    │  │ /tasks/    │   │   │
│  │  │  /create   │  │ {id}/status│  │   sync     │   │   │
│  │  └────────────┘  └────────────┘  └────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
└────────────────────────────┬────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                      ビジネスロジック層                      │
│  ┌─────────────────┐     ┌──────────────────────────┐     │
│  │ markdown_sync.py│     │      models.py           │     │
│  │ ┌─────────────┐ │     │  ┌─────────────────┐   │     │
│  │ │ TaskParser  │ │     │  │   TaskIndex     │   │     │
│  │ └─────────────┘ │     │  │ - id: UUID      │   │     │
│  │ ┌─────────────┐ │     │  │ - status: Enum  │   │     │
│  │ │ TaskWriter  │ │     │  │ - file_path: str│   │     │
│  │ └─────────────┘ │     │  │ - updated_at    │   │     │
│  └─────────────────┘     │  └─────────────────┘   │     │
└────────────────────────────┴──────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                      データ層                                │
│  ┌─────────────────────┐     ┌──────────────────────┐     │
│  │   Markdownファイル   │     │     TinyDB          │     │
│  │   (tasks/*.md)      │◀───▶│  (db/tasks_db.json) │     │
│  │   [真実の源]        │ sync │   [検索インデックス]  │     │
│  └─────────────────────┘     └──────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

### コンポーネント詳細

#### 1. MCPサーバー層 (main.py)
- FastAPI-MCPを使用してMCPプロトコルを実装
- Server-Sent Events (SSE)でクライアントと通信
- FastAPIアプリケーションをMCPツールとして公開

#### 2. API層 (api.py)
- RESTful APIエンドポイントを定義
- リクエスト検証とレスポンス生成
- バックグラウンドタスクでの非同期処理

#### 3. ビジネスロジック層

**markdown_sync.py**
- `MarkdownTaskParser`: Markdownファイルからタスク情報を抽出
  - YAMLフロントマター解析
  - フォールバックとしての正規表現パース
  - ディレクトリスキャン機能
  
- `MarkdownTaskWriter`: タスク情報をMarkdownファイルに書き込み
  - フロントマター更新
  - ファイル作成・更新
  - ステータス同期

**models.py**
- Pydanticモデルによる型安全性
- 自動バリデーション
- JSONシリアライゼーション

#### 4. データ層
- **Markdownファイル**: 永続的なデータストレージ
- **TinyDB**: 高速検索のためのインメモリインデックス

## データフロー

### 1. タスク作成フロー
```
Claude Code → MCP → API (/tasks/create) → MarkdownTaskWriter
                                              ↓
                                         Markdownファイル作成
                                              ↓
                                         TinyDBインデックス更新
```

### 2. ステータス更新フロー
```
Claude Code → MCP → API (/tasks/{id}/status) → TinyDB更新
                                                    ↓
                                            MarkdownTaskWriter
                                                    ↓
                                            Markdownファイル更新
```

### 3. 同期フロー
```
Markdownファイル変更 → API (/tasks/sync) → MarkdownTaskParser
                                              ↓
                                         全ファイルスキャン
                                              ↓
                                         TinyDB再構築
```

## セキュリティ考慮事項

### 現在の実装
- ローカルホストのみでの動作（localhost:8000）
- 認証・認可機能なし（ローカル開発用）
- ファイルシステムへの直接アクセス

### 将来の拡張
- JWT/OAuthによる認証
- ロールベースアクセス制御（RBAC）
- APIレート制限
- 入力検証の強化

## スケーラビリティ

### 現在の制限
- シングルインスタンス動作
- ファイルシステムベース（分散環境では課題）
- TinyDBのメモリ制限

### スケーリング戦略
1. **読み取りスケーリング**: 複数のAPIインスタンスでTinyDBを共有
2. **書き込みスケーリング**: ファイルロックメカニズムの実装
3. **データベース移行**: PostgreSQL/MongoDBへの移行パス
4. **キャッシング**: Redis/Memcachedの導入

## 拡張ポイント

### 1. 実行環境統合
```python
# 将来の実装例
class TaskExecutor:
    def execute_in_tmux(self, task_id: str):
        # tmuxセッションでタスクを実行
        pass
```

### 2. Git統合強化
```python
# 将来の実装例
class GitIntegration:
    def create_branch_for_task(self, task_id: str):
        # タスク用のGitブランチを作成
        pass
```

### 3. AIエージェント最適化
```python
# 将来の実装例
class AIOptimizer:
    def suggest_next_task(self, context: dict):
        # AIに最適な次のタスクを提案
        pass
```

## 監視とロギング

### 現在の実装
- Uvicornの標準ロギング
- FastAPIの自動エラーハンドリング

### 推奨される拡張
- 構造化ロギング（JSON形式）
- メトリクス収集（Prometheus）
- 分散トレーシング（OpenTelemetry）
- エラー追跡（Sentry）

## まとめ

TaskHub MCPのアーキテクチャは、AIエージェントとの効率的な統合を最優先に設計されています。Gitネイティブなアプローチにより、完全な履歴追跡と分散開発をサポートし、シンプルながら拡張可能な構造を実現しています。